<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; }
    header { position: sticky; top: 0; background:#fff; padding:12px 16px; border-bottom:1px solid #eee; z-index: 5;}
    .row { border-bottom:1px solid #eee; padding:10px 14px; }
    .summary { display:grid; grid-template-columns: 140px 1fr 150px 160px; gap:8px; align-items:center; }
    .summary > div { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    details { border:1px solid #e8e8e8; border-radius:12px; margin:10px 0; background:#fafafa; }
    details[open] { background: #fff; }
    summary { list-style:none; cursor:pointer; padding:10px 14px; }
    summary::-webkit-details-marker { display:none; }
    .items { padding:4px 16px 10px 16px; }
    .pill { display:inline-block; padding:4px 8px; border:1px solid #ddd; border-radius:999px; margin:4px 6px 0 0; }
    .muted { color:#667; font-size:12px; }
    .flex { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    .box { border:1px solid #e6e6e6; border-radius:10px; background:#fff; padding:10px; }
    .col { display:flex; flex-direction:column; gap:6px; }
    textarea { width:100%; min-height:120px; font-family:inherit; font-size:14px; }
    input[type="text"] { width:100%; padding:6px 8px; }
    .btn { cursor:pointer; border:1px solid #ddd; background:#f7f7f7; border-radius:8px; padding:6px 10px; }
    .btn:hover { background:#efefef; }
    .link { word-break: break-all; }
    .grid { display:grid; grid-template-columns: 1.2fr 1fr; gap:12px; }
    .kvs { display:grid; grid-template-columns: repeat(4, minmax(90px, 1fr)); gap:6px 10px; }
    .kvs div { font-size:12px; color:#333; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .tag { background:#fff7e6; border:1px solid #ffe3a3; padding:2px 6px; border-radius:6px; font-size:12px; }
    .sticky-actions { position:sticky; bottom:0; background:#fff; padding:8px 16px; border-top:1px solid #eee; display:flex; gap:8px; }
  </style>
</head>
<body>
  <header>
    <div class="flex">
      <strong>Contactar Cliente â€” Dashboard</strong>
      <span class="muted">Una fila por pedido â€¢ Click para ver productos â€¢ Genera el link de WhatsApp por fila</span>
    </div>
    <div class="flex" style="margin-top: 10px; padding: 10px; background-color: #f7f7f7; border-radius: 8px; gap: 10px;">
      <input type="text" id="product-search" list="product-suggestions" placeholder="Buscar producto para notificar..." style="flex-grow: 1; padding: 6px 8px;">
      <datalist id="product-suggestions"></datalist>
      <button class="btn" onclick="filterOrders()">Buscar</button>
      <button class="btn" onclick="clearFilter()">Limpiar</button>
      <button class="btn" onclick="bulkSelect()">Seleccionar Todos</button>
    </div>
  </header>

  <div id="container"><div style="padding:20px; color:#777;">Cargando pedidos...</div></div>
  <div id="error-box" style="display:none; margin:10px; padding:15px; background-color:#fff0f0; border:1px solid #ffdada; color:#d8000c; border-radius:5px;"></div>

  <script>
    const state = {
      orders: [],
      template: '',
      formURL: ''
    };

    function copyText(txt) {
      navigator.clipboard.writeText(txt).then(()=>{}).catch(()=>{});
    }

    function render() {
      const wrap = document.getElementById('container');
      wrap.innerHTML = '';

      state.orders.forEach((o, idx) => {
        const det = document.createElement('details');
        det.className = 'row';
        det.open = false;

        // SUMMARY (fila principal)
        const sum = document.createElement('summary');
        const grid = document.createElement('div');
        grid.className = 'summary';
        grid.innerHTML = `
          <div><strong>#${o.pedido}</strong></div>
          <div>${escapeHtml(o.nombre)}</div>
          <div>ðŸ“ž ${escapeHtml(o.telefono || '')}</div>
          <div class="muted">${escapeHtml(o.fecha || '')}</div>
        `;
        sum.appendChild(grid);

        // BODY (acordeÃ³n con productos + generador de link)
        const body = document.createElement('div');
        body.className = 'items';

        // Productos (checkbox)
        const prods = document.createElement('div');
        prods.className = 'box';
        const itemsHtml = o.items.map((it,i) => {
          const id = `p_${idx}_${i}`;
          return `
            <label class="pill">
              <input type="checkbox" id="${id}" data-idx="${idx}" data-name="${escapeHtml(it.nombreProducto)}" data-cantidad="${escapeHtml(it.cantidad)}" onchange="updateRow(${idx})">
              ${escapeHtml(it.nombreProducto)} â€” <span class="muted">${escapeHtml(it.cantidad)}</span>
            </label>
          `;
        }).join('');
        prods.innerHTML = `<div><strong>Productos del pedido</strong></div><div class="flex">${itemsHtml || '<span class="muted">Sin items</span>'}</div>`;

        // Datos clave
        const info = document.createElement('div');
        info.className = 'box';
        info.innerHTML = `
          <div class="kvs">
            <div><span class="muted">Email</span><br>${escapeHtml(o.email || '')}</div>
            <div><span class="muted">DirecciÃ³n</span><br>${escapeHtml(o.direccion || '')}</div>
            <div><span class="muted">Depto/Cond.</span><br>${escapeHtml(o.depto || '')}</div>
            <div><span class="muted">Comuna</span><br>${escapeHtml(o.comuna || '')}</div>
          </div>
        `;

        // Template + Link
        const tl = document.createElement('div');
        tl.className = 'grid';
        tl.innerHTML = `
          <div class="col box">
            <label class="muted">TelÃ©fono (se normaliza a +56*)</label>
            <input type="text" id="tel_${idx}" value="${escapeAttr(o.telefono || '')}" oninput="updateRow(${idx})">
            <label class="muted">Plantilla de mensaje (usa {PRODUCTOS}, {PEDIDO}, {NOMBRE}, {DIRECCION}, {COMUNA}, {FORM_LINK})</label>
            <textarea id="tpl_${idx}" oninput="updateRow(${idx})"></textarea>
          </div>
          <div class="col box">
            <label class="muted">Links para contactar</label>
            <div class="flex">
                <a id="wa_${idx}" class="btn" href="#" target="_blank">Abrir Chat (App)</a>
                <a id="wa_web_${idx}" class="btn" href="#" target="_blank">Abrir Chat (Web)</a>
            </div>
            <label class="muted" style="margin-top:10px;">Copiar</label>
            <div class="flex">
              <button class="btn" onclick="copyLink(${idx})">Copiar Link (App)</button>
              <button class="btn" onclick="copyWebLink(${idx})">Copiar Link (Web)</button>
              <button class="btn" onclick="copyMsg(${idx})">Copiar Mensaje</button>
            </div>
            <div class="muted" id="msgprev_${idx}" style="margin-top:10px; border-top: 1px solid #eee; padding-top:10px;"></div>
          </div>
        `;

        body.appendChild(prods);
        body.appendChild(info);
        body.appendChild(tl);

        det.appendChild(sum);
        det.appendChild(body);
        wrap.appendChild(det);

        // set template inicial
        document.getElementById(`tpl_${idx}`).value = state.template;
        // generar primer link
        updateRow(idx);
      });
    }

    function selectedProducts(idx) {
      const checks = Array.from(document.querySelectorAll(`[id^="p_${idx}_"]`));
      const products = checks
        .filter(c => c.checked)
        .map(c => ({
          name: c.getAttribute('data-name'),
          quantity: c.getAttribute('data-cantidad')
        }));
      return products;
    }

    function updateRow(idx) {
      const o = state.orders[idx];
      if (!o) return;

      const tel = document.getElementById(`tel_${idx}`).value || '';
      const tpl = document.getElementById(`tpl_${idx}`).value || state.template;

      const prods = selectedProducts(idx);

      google.script.run.withSuccessHandler(({message, link, webLink}) => {
        document.getElementById(`wa_${idx}`).href = link;
        document.getElementById(`wa_web_${idx}`).href = webLink;
        document.getElementById(`msgprev_${idx}`).textContent = message;
      }).getWhatsAppLinkFromTemplate(o, prods, tpl, state.formURL);
    }

    function copyLink(idx) {
      const a = document.getElementById(`wa_${idx}`);
      copyText(a.href);
    }
    function copyWebLink(idx) {
      const a = document.getElementById(`wa_web_${idx}`);
      copyText(a.href);
    }
    function copyMsg(idx) {
      const prev = document.getElementById(`msgprev_${idx}`).textContent || '';
      copyText(prev);
    }

    function escapeHtml(s) {
      return (s || '').toString()
        .replaceAll('&', '&amp;').replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;').replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }
    function escapeAttr(s){ return escapeHtml(s).replaceAll('"','&quot;'); }

    function filterOrders() {
      const searchTerm = document.getElementById('product-search').value.toLowerCase().trim();
      if (!searchTerm) return;

      const orderRows = document.querySelectorAll('.row');
      orderRows.forEach((row, idx) => {
        const order = state.orders[idx];
        if (!order) return;

        const hasProduct = order.items.some(item =>
          item.nombreProducto.toLowerCase().includes(searchTerm)
        );

        row.style.display = hasProduct ? 'block' : 'none';
      });
    }

    function clearFilter() {
      document.getElementById('product-search').value = '';
      const orderRows = document.querySelectorAll('.row');
      orderRows.forEach(row => {
        row.style.display = 'block';
      });
    }

    function bulkSelect() {
      const searchTerm = document.getElementById('product-search').value.toLowerCase().trim();
      if (!searchTerm) {
        alert('Por favor, primero busca un producto para poder seleccionarlo masivamente.');
        return;
      }

      const orderRows = document.querySelectorAll('.row');
      orderRows.forEach((row, idx) => {
        if (row.style.display === 'none') return;

        const order = state.orders[idx];
        if (!order) return;

        let productWasSelected = false;
        order.items.forEach((item, itemIdx) => {
          if (item.nombreProducto.toLowerCase().includes(searchTerm)) {
            const checkboxId = `p_${idx}_${itemIdx}`;
            const checkbox = document.getElementById(checkboxId);
            if (checkbox && !checkbox.checked) {
              checkbox.checked = true;
              productWasSelected = true;
            }
          }
        });

        if (productWasSelected) {
          updateRow(idx);
          row.open = true;
        }
      });
    }

    // Cargar datos
    google.script.run
    .withFailureHandler(err => {
      const container = document.getElementById('container');
      container.innerHTML = ''; // Limpiar 'Cargando...'
      const errBox = document.getElementById('error-box');
      errBox.style.display = 'block';
      errBox.innerText = 'Error al cargar los datos: ' + err.message +
        '\\n\\nAsegÃºrate de que la hoja se llame "Orders" y que tenga todas las columnas requeridas.';
    })
    .withSuccessHandler(({orders, template, formURL, productNames}) => {
      document.getElementById('error-box').style.display = 'none';

      if (!orders) {
          document.getElementById('container').innerHTML = '<div style="padding:20px; color:#777;">OcurriÃ³ un error inesperado al recibir los datos.</div>';
          return;
      }

      state.orders = orders || [];
      state.template = template || '';
      state.formURL = formURL || '';

      const datalist = document.getElementById('product-suggestions');
      if (productNames && datalist) {
        datalist.innerHTML = '';
        productNames.forEach(name => {
          if (name) { // Ensure name is not empty
            const option = document.createElement('option');
            option.value = name;
            datalist.appendChild(option);
          }
        });
      }

      if (state.orders.length === 0) {
        document.getElementById('container').innerHTML = '<div style="padding:20px; color:#777;">No se encontraron pedidos.</div>';
      } else {
        render();
      }
    }).fetchOrdersAggregated();
  </script>
</body>
</html>
